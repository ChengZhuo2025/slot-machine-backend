# =====================================================
# Kubernetes Service Configuration
# 爱上杜美人智能开锁管理系统后端服务
# =====================================================

apiVersion: v1
kind: Service
metadata:
  name: smart-locker-api
  labels:
    app: smart-locker
    component: api-gateway
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
  selector:
    app: smart-locker
    component: api-gateway

---
# Headless Service for StatefulSet (if needed)
apiVersion: v1
kind: Service
metadata:
  name: smart-locker-api-headless
  labels:
    app: smart-locker
    component: api-gateway
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP
  selector:
    app: smart-locker
    component: api-gateway

---
# ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: smart-locker
  labels:
    app: smart-locker

---
# Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: smart-locker-api
  labels:
    app: smart-locker
    component: api-gateway
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - api.smart-locker.example.com
      secretName: smart-locker-api-tls
  rules:
    - host: api.smart-locker.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: smart-locker-api
                port:
                  name: http

---
# ConfigMap for application configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: smart-locker-config
  labels:
    app: smart-locker
data:
  config.yaml: |
    server:
      port: 8080
      mode: release
      read_timeout: 30s
      write_timeout: 30s
      shutdown_timeout: 10s

    log:
      level: info
      format: json
      output: stdout

    cors:
      allowed_origins:
        - "*"
      allowed_methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowed_headers:
        - Authorization
        - Content-Type
        - X-Request-ID
      max_age: 86400

    rate_limit:
      enabled: true
      requests_per_second: 100
      burst: 200

    metrics:
      enabled: true
      path: /metrics

    tracing:
      enabled: true
      sample_rate: 0.1
      endpoint: ""  # OTLP endpoint from env

---
# Secret template (values should be provided during deployment)
apiVersion: v1
kind: Secret
metadata:
  name: smart-locker-db-secret
  labels:
    app: smart-locker
type: Opaque
stringData:
  host: "postgres"
  port: "5432"
  username: "postgres"
  password: "changeme"
  database: "smart_locker"

---
apiVersion: v1
kind: Secret
metadata:
  name: smart-locker-redis-secret
  labels:
    app: smart-locker
type: Opaque
stringData:
  host: "redis"
  port: "6379"
  password: "changeme"

---
apiVersion: v1
kind: Secret
metadata:
  name: smart-locker-mqtt-secret
  labels:
    app: smart-locker
type: Opaque
stringData:
  broker: "tcp://emqx:1883"

---
apiVersion: v1
kind: Secret
metadata:
  name: smart-locker-jwt-secret
  labels:
    app: smart-locker
type: Opaque
stringData:
  secret: "your-jwt-secret-key-here"

---
# NetworkPolicy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: smart-locker-api
  labels:
    app: smart-locker
    component: api-gateway
spec:
  podSelector:
    matchLabels:
      app: smart-locker
      component: api-gateway
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    - to:
        - podSelector:
            matchLabels:
              app: emqx
      ports:
        - protocol: TCP
          port: 1883
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
