# Feature Specification: 爱上杜美人智能开锁管理系统后端服务

**Feature Branch**: `001-smart-locker-backend`
**Created**: 2026-01-02
**Status**: Draft
**Input**: User description: "爱上杜美人"智能开锁管理系统后端服务开发规范 - B2B2C智能柜租借与电商平台

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 用户扫码租借智能柜中的成人情趣用品 (Priority: P1)

用户通过微信扫描智能柜上的二维码，完成身份验证后选择租借时长，支付押金和租金后，系统远程开锁，用户取用成人情趣用品。归还时扫码确认，系统自动结算并退还押金余额。

**Why this priority**: 这是平台的核心业务场景，直接产生收入，是整个系统存在的基础价值。

**Independent Test**: 可通过模拟用户完整租借流程进行端到端测试，验证从扫码→支付→开锁→归还→结算的完整链路。

**Acceptance Scenarios**:

1. **Given** 用户首次使用平台, **When** 用户扫描智能柜二维码, **Then** 系统引导用户完成微信授权登录并显示柜子中的产品详情
2. **Given** 用户已登录且选择租借时长, **When** 用户完成支付, **Then** 系统在3秒内发送开锁指令，柜门自动打开
3. **Given** 用户正在使用租借服务且超过租借时长, **When** 系统检测到超时, **Then** 自动按超时费率计费并通知用户
4. **Given** 用户归还物品并扫码确认, **When** 系统检测到柜门关闭, **Then** 自动结算费用并退还剩余押金到用户钱包

---

### User Story 2 - 管理员设备监控与管理 (Priority: P1)

平台运营管理员通过后台系统实时查看所有智能柜设备的在线状态、使用情况和异常告警，可远程执行重启、开锁测试等操作，并管理设备所属场地和商户信息。

**Why this priority**: 设备正常运行是业务开展的前提，设备管理直接影响服务可用性和用户体验。

**Independent Test**: 可通过管理后台进行设备状态查看、远程控制操作，验证设备管理全流程。

**Acceptance Scenarios**:

1. **Given** 管理员登录后台, **When** 进入设备管理页面, **Then** 显示所有设备列表及实时状态（在线/离线/故障）
2. **Given** 设备出现异常, **When** 设备上报故障状态, **Then** 系统在1分钟内发送告警通知给相关管理员
3. **Given** 管理员选择某台设备, **When** 执行远程开锁测试, **Then** 系统发送指令并在5秒内返回执行结果

---

### User Story 3 - 用户商城购物 (Priority: P2)

用户在平台商城浏览商品、加入购物车、下单支付，可使用优惠券抵扣，订单支付后安排配送。用户可查看订单状态、申请退款、评价商品。

**Why this priority**: 商城是平台收入的重要补充，增加用户粘性和复购率。

**Independent Test**: 可通过完整购物流程测试，从商品浏览→加购→下单→支付→评价的完整链路。

**Acceptance Scenarios**:

1. **Given** 用户浏览商城, **When** 搜索商品关键词, **Then** 系统在1秒内返回相关商品列表
2. **Given** 用户购物车有商品, **When** 提交订单并选择优惠券, **Then** 系统正确计算优惠后金额
3. **Given** 用户已支付订单, **When** 申请退款, **Then** 系统创建退款工单并通知客服处理

---

### User Story 4 - 酒店房间智能柜租借 (Priority: P2)

用户通过平台预订酒店房间，选择入住时段并支付钟点费后，系统生成入住核销二维码和开锁码。用户到酒店前台出示核销二维码（或预订订单）办理入住，进入房间后直接输入开锁码打开智能柜取出物品使用。退房时将物品放回柜中关闭即可。此流程与普通场地扫码租借的区别在于：酒店场景在预订时已完成支付，进房间后无需再次扫码下单。

**Why this priority**: 酒店房间场景是智能柜部署的重要渠道，与商户场地模式形成互补，扩大业务覆盖面。

**Independent Test**: 可通过房间预订支付→核销码/开锁码生成→前台核销→输入开锁码开锁的完整流程进行测试。

**Acceptance Scenarios**:

1. **Given** 用户选择酒店房间和入住时段, **When** 完成支付, **Then** 系统确认预订并生成入住核销二维码和开锁码
2. **Given** 用户到店出示核销二维码, **When** 前台确认核销, **Then** 系统更新预订状态为已入住
3. **Given** 用户进入房间, **When** 输入开锁码, **Then** 系统验证开锁码有效后发送开锁指令打开智能柜
4. **Given** 用户使用完毕退房, **When** 物品放回并关闭柜门, **Then** 系统自动检测关闭状态并完成订单

---

### User Story 5 - 分销商推广与佣金管理 (Priority: P2)

分销商通过平台生成专属推广链接，分享给潜在用户。用户通过推广链接注册并产生消费后，分销商按规则获得佣金。分销商可查看团队成员、佣金明细并申请提现。

**Why this priority**: 分销体系是平台快速获客的重要渠道，直接影响用户增长。

**Independent Test**: 可通过分销链接注册→消费→佣金计算→提现的完整流程测试。

**Acceptance Scenarios**:

1. **Given** 分销商申请已审核通过, **When** 生成推广链接, **Then** 系统创建带有分销商标识的专属链接
2. **Given** 新用户通过推广链接注册并消费, **When** 订单完成, **Then** 系统按佣金规则计算并记录分销商收益
3. **Given** 分销商佣金余额满足提现条件, **When** 申请提现, **Then** 系统创建提现申请并提交财务审核

---

### User Story 6 - 财务对账与结算 (Priority: P3)

财务管理员通过后台查看平台收入统计、交易流水、分账明细，执行商户结算和分销商佣金结算，审核提现申请，导出财务报表。

**Why this priority**: 财务管理保障平台资金安全和合规运营，是后台支撑功能。

**Independent Test**: 可通过财务报表查询、结算操作、提现审核的独立测试验证。

**Acceptance Scenarios**:

1. **Given** 财务管理员登录后台, **When** 查看当日收入统计, **Then** 系统显示按渠道分类的收入汇总
2. **Given** 有待结算的商户分成, **When** 执行批量结算, **Then** 系统生成结算单并记录资金流转
3. **Given** 有待审核的提现申请, **When** 审核通过并执行打款, **Then** 系统更新提现状态并通知申请人

---

### User Story 7 - 营销活动与优惠券管理 (Priority: P3)

运营管理员创建优惠券模板、配置发放规则、管理营销活动。用户领取优惠券后可在符合条件的订单中使用。

**Why this priority**: 营销工具促进用户活跃和转化，但属于运营增强功能。

**Independent Test**: 可通过优惠券创建→发放→用户领取→订单使用的流程测试。

**Acceptance Scenarios**:

1. **Given** 运营管理员创建优惠券, **When** 设置满减规则和有效期, **Then** 系统保存优惠券模板并可配置发放渠道
2. **Given** 用户符合领取条件, **When** 领取优惠券, **Then** 优惠券添加到用户账户且库存相应减少
3. **Given** 用户下单使用优惠券, **When** 优惠券过期或不满足使用条件, **Then** 系统提示无法使用并说明原因

---

### User Story 8 - 会员体系与权益管理 (Priority: P3)

用户通过消费累积积分、提升会员等级，不同等级享受不同权益（折扣、专属优惠等）。用户可购买会员套餐快速升级。

**Why this priority**: 会员体系增强用户忠诚度，但需要基础业务稳定后再完善。

**Independent Test**: 可通过消费积分累积→等级升级→权益生效的流程测试。

**Acceptance Scenarios**:

1. **Given** 用户完成消费, **When** 订单完成, **Then** 系统按规则计算并累加用户积分
2. **Given** 用户积分达到升级门槛, **When** 系统检测到积分变化, **Then** 自动提升用户会员等级并通知用户
3. **Given** 用户为高级会员, **When** 下单时, **Then** 系统自动应用会员专属折扣

---

### Edge Cases

#### 设备与租借相关
- 用户租借过程中设备离线怎么处理？（系统需保留租借状态，设备恢复后同步）
- 支付成功但开锁失败如何处理？（自动重试3次，每次间隔2秒，失败后创建工单并通知客服，同时支持用户手动重试）
- 设备在租借期间被其他用户扫码？（提示设备使用中，显示预计可用时间）
- 用户超过24小时未归还产品？（扣除全部押金，订单状态变更为"已购买"，产品从库存中移除）
- **网络超时/重试场景**：设备通信超时（3秒无响应）自动重试3次，重试间隔指数递增（1s/2s/4s），全部失败后标记设备为"通信异常"状态，触发告警通知运维人员
- **并发订单冲突场景**：同一设备同时只能有一个"待支付"状态的订单，使用分布式锁（Redis）防止并发创建，若已存在待支付订单则返回错误提示用户完成或取消现有订单

#### 支付相关
- **支付金额不匹配场景**：支付回调金额与订单金额不一致时，拒绝更新订单状态，记录异常日志并触发告警，由财务人员人工核实处理
- 用户申请退款时优惠券如何处理？（全额退款时优惠券恢复可用状态，部分退款时优惠券作废）

#### 商城相关
- **库存不足场景**：下单前实时检查库存，库存不足时返回具体缺货商品信息；支付时二次校验库存，若库存已被占用则自动退款并通知用户

#### 酒店预订相关
- **房间已预订场景**：预订前检查时段是否冲突，已预订时段在前端置灰不可选；提交预订时二次校验，若时段已被占用则返回错误提示用户重新选择

#### 营销与分销相关
- 用户同时使用多张优惠券的冲突处理？（按规则限制叠加使用，同类型优惠券不可叠加）
- 分销关系出现循环推荐如何处理？（系统检测并拒绝循环绑定，A推荐B后，B不能再推荐A或A的上级）
- 商户分成比例变更对历史订单的影响？（按订单创建时的比例结算，比例变更仅影响新订单）

## Requirements *(mandatory)*

### Functional Requirements

#### 认证授权模块

- **FR-001**: 系统必须支持手机验证码登录，验证码有效期5分钟，同一手机号每分钟最多发送1次
- **FR-002**: 系统必须支持微信授权登录，自动获取用户头像和昵称
- **FR-003**: 系统必须支持JWT Token认证，采用双Token机制：Access Token有效期可配置（范围：2小时~7天，默认2小时），Refresh Token有效期可配置（范围：7天~30天，默认30天）。Access Token过期后可使用Refresh Token无感刷新
- **FR-004**: 系统必须支持6种管理角色：超级管理员、平台管理员、运营管理员、财务管理员、合作商、客服
- **FR-005**: 系统必须实现基于角色的权限控制，每个API接口配置所需权限

#### 用户管理模块

- **FR-006**: 系统必须支持用户信息的增删改查，包括头像、昵称、手机号、实名信息
- **FR-007**: 系统必须支持用户反馈提交和处理流程
- **FR-008**: 系统必须支持会员等级体系，包含等级规则、积分计算、权益配置
- **FR-009**: 系统必须支持用户钱包功能，包括余额查询、充值、消费、提现
- **FR-010**: 系统必须支持用户实名认证，存储加密后的身份证信息

#### 设备管理模块

- **FR-011**: 系统必须支持智能柜设备的注册、配置、状态查询、远程控制
- **FR-012**: 系统必须在设备添加后自动生成该设备的专属二维码，供用户扫码租借使用
- **FR-013**: 系统必须支持场地管理，记录设备部署位置（商城、酒店、社区、办公楼等）
- **FR-014**: 系统必须支持商户管理，包括商户信息、分成比例配置
- **FR-015**: 系统必须记录设备维护历史，包括维护时间、类型、结果
- **FR-016**: 系统必须支持远程控制命令：重启、开锁测试、状态刷新
- **FR-017**: 系统必须接收设备实时状态上报，异常时触发告警通知

#### 酒店预订模块

- **FR-018**: 系统必须支持酒店信息管理，包括基本信息、图片、设施、位置、合作状态
- **FR-019**: 系统必须支持房间管理，包括房型、时段价格、库存、房态、关联的智能柜设备ID
- **FR-020**: 系统必须支持预订创建（选择时段并支付钟点费），支付成功后生成入住核销二维码和开锁码
- **FR-021**: 系统必须支持前台核销功能，扫描核销二维码或输入订单号验证后更新预订状态为已入住
- **FR-022**: 系统必须支持开锁码验证，开锁码仅在预订时段内有效，用户输入开锁码后系统验证有效性并发送开锁指令

#### 商城模块

- **FR-023**: 系统必须支持商品分类的层级管理
- **FR-024**: 系统必须支持商品的增删改查，包括SKU、价格、库存、图片、描述
- **FR-025**: 系统必须支持购物车功能，包括添加、修改数量、删除、清空
- **FR-026**: 系统必须支持商品评价，包括评分、文字、图片
- **FR-027**: 系统必须支持商品搜索，支持关键词、分类、价格区间筛选

#### 订单模块

- **FR-028**: 系统必须支持统一订单创建，区分订单类型（酒店预订、商品购买、设备租借）
- **FR-029**: 系统必须支持订单状态流转：待支付→已支付→进行中→已完成/已取消/已退款
- **FR-030**: 系统必须支持退款申请和处理流程
- **FR-031**: 系统必须支持订单统计，按时间、类型、渠道汇总

#### 支付模块

- **FR-032**: 系统必须集成微信支付，支持JSAPI、小程序支付
- **FR-033**: 系统必须集成支付宝支付，支持手机网站支付
- **FR-034**: 系统必须正确处理支付回调，更新订单状态
- **FR-035**: 系统必须记录完整交易流水，支持对账
- **FR-036**: 系统必须支持原路退款

#### 租借价格模块

- **FR-037**: 系统必须支持按时长配置租借价格（1h/2h/3h/6h/12h/24h）
- **FR-038**: 系统必须支持押金配置和管理
- **FR-039**: 系统必须支持超时费率配置和自动计算
- **FR-040**: 系统必须支持批量调整价格

#### 营销模块

- **FR-041**: 系统必须支持优惠券模板创建，配置面额、使用条件、有效期
- **FR-042**: 系统必须支持优惠券批量发放和定向发放
- **FR-043**: 系统必须支持营销活动管理，配置活动规则和时间
- **FR-044**: 系统必须支持会员套餐配置和购买
- **FR-045**: 系统必须支持推广链接生成和追踪

#### 财务模块

- **FR-046**: 系统必须提供收入统计，支持按日/周/月/年维度
- **FR-047**: 系统必须支持分账结算，按配置比例计算商户和分销商收益
- **FR-048**: 系统必须支持提现申请、审核、打款流程
- **FR-049**: 系统必须支持财务报表导出（Excel格式）

#### 分销模块

- **FR-050**: 系统必须支持分销商申请和审核流程
- **FR-051**: 系统必须支持多级佣金计算（直推、间推），佣金按订单实付金额（扣除优惠后）计算
- **FR-052**: 系统必须记录分销团队关系树
- **FR-053**: 系统必须支持佣金提现，与财务模块联动

#### 内容管理模块

- **FR-054**: 系统必须支持帮助文章和FAQ管理
- **FR-055**: 系统必须支持站内消息通知
- **FR-056**: 系统必须支持消息模板配置（短信、推送）
- **FR-057**: 系统必须支持批量消息推送

#### 系统管理模块

- **FR-058**: 系统必须支持平台配置管理（基本信息、业务规则、支付参数）
- **FR-059**: 系统必须记录所有管理员操作日志
- **FR-060**: 系统必须支持缓存管理（查看、清除）
- **FR-061**: 系统必须支持角色权限配置

#### 仪表盘模块

- **FR-062**: 系统必须为平台管理员提供整体数据概览（收入、订单、用户、设备）
- **FR-063**: 系统必须为分销商提供佣金和团队数据展示
- **FR-064**: 系统必须为财务管理员提供资金流动概览
- **FR-065**: 系统必须为运营管理员提供用户增长和营销效果数据

#### 数据合规模块（PIPL）

- **FR-066**: 系统必须支持用户数据导出功能，用户可请求导出其所有个人数据（包括账户信息、订单历史、消费记录、积分记录等），系统在7个工作日内提供可下载的数据包（JSON/CSV格式）
- **FR-067**: 系统必须支持用户账户注销功能，用户提交注销申请后，系统在15个工作日内完成以下操作：（1）删除或匿名化用户个人身份信息；（2）保留因法律要求需留存的交易记录（仅保留脱敏后的必要字段）；（3）解除所有分销关系绑定；（4）清零用户钱包余额（需先完成提现）

#### API 设计规范

- **FR-068**: 系统所有创建类API（POST）必须支持幂等性设计，通过请求头传递幂等键（X-Idempotency-Key），同一幂等键的重复请求返回首次执行结果，幂等键有效期为24小时
- **FR-069**: 系统所有支付相关API必须实现幂等性保护，防止因网络重试导致重复扣款或重复创建订单

### Key Entities

- **User（用户）**: 平台终端用户，包含账号信息、会员等级、钱包余额、实名状态
- **Admin（管理员）**: 后台管理人员，关联角色和权限
- **Device（设备）**: 智能柜设备，包含设备编号、专属二维码、状态、所属场地、商户
- **Venue（场地）**: 设备部署地点，包含位置、类型、联系方式
- **Merchant（商户）**: 设备合作商，包含基本信息、分成比例、结算账户
- **Hotel（酒店）**: 酒店信息，包含位置、设施、房间列表
- **Room（房间）**: 酒店房间，包含房型、价格、房态、关联的智能柜设备ID
- **Booking（预订）**: 酒店预订记录，包含用户、房间、入离时间、核销二维码、开锁码、状态、关联的智能柜设备
- **Product（商品）**: 商城商品，包含分类、SKU、价格、库存
- **CartItem（购物车项）**: 用户购物车，关联商品和数量
- **Order（订单）**: 统一订单，包含类型、金额、状态、支付信息
- **OrderItem（订单项）**: 订单明细，关联商品或服务
- **Payment（支付）**: 支付记录，包含渠道、金额、状态、回调信息
- **Rental（租借）**: 设备租借记录，包含设备、时长、费用、押金
- **RentalPricing（租借定价）**: 价格配置，包含时长档位和费率
- **Coupon（优惠券）**: 优惠券模板，包含面额、条件、有效期
- **UserCoupon（用户优惠券）**: 用户领取的优惠券实例
- **Campaign（营销活动）**: 活动配置，包含规则、时间、奖励
- **Distributor（分销商）**: 分销商信息，包含审核状态、佣金余额
- **Commission（佣金）**: 佣金记录，关联订单、分销商、金额
- **Withdrawal（提现）**: 提现申请，包含金额、状态、审核信息
- **Settlement（结算）**: 分账结算记录，关联商户或分销商
- **Article（文章）**: 帮助文档和公告
- **Notification（通知）**: 消息通知，包含类型、内容、目标用户
- **OperationLog（操作日志）**: 管理员操作审计记录
- **SystemConfig（系统配置）**: 平台配置项，键值对存储

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户从扫码到成功开锁的完整流程可在60秒内完成
- **SC-002**: 设备状态变更在30秒内同步到管理后台
- **SC-003**: 商品搜索结果在1秒内返回
- **SC-004**: 系统支持10,000并发用户正常使用
- **SC-005**: 支付成功率达到99.5%以上
- **SC-006**: 设备在线率监控准确率达到99%
- **SC-007**: 订单状态查询响应时间低于200毫秒
- **SC-008**: 财务报表可在10秒内生成并导出
- **SC-009**: 系统可用性达到99.9%（年停机时间不超过8.76小时）
- **SC-010**: 敏感数据（身份证、银行卡）100%加密存储
- **SC-011**: 所有管理员操作100%记录审计日志
- **SC-012**: 分销佣金计算准确率达到100%

## Clarifications

### Session 2026-01-02

- Q: 智能柜中租借的产品类型是什么？ → A: 成人情趣用品（如情趣玩具）
- Q: 酒店预订开锁码的有效期规则？ → A: 仅预订时段内有效
- Q: 分销佣金的计算基准是什么？ → A: 按实付金额（扣除优惠后）计算
- Q: 用户未归还产品如何处理？ → A: 超过24小时未归还扣除全部押金，视为购买
- Q: 设备与服务端的通信协议？ → A: MQTT（物联网标准协议）

## Assumptions

- 智能柜租借的产品为成人情趣用品，用户需年满18周岁方可使用服务
- 微信支付和支付宝的商户账号已开通并完成资质认证
- 智能柜设备具备网络连接能力，支持接收远程控制指令
- 设备端与服务端通过 MQTT 协议保持长连接，支持 QoS 消息保证和离线消息队列
- 短信服务商已对接，可发送验证码和通知短信
- 用户主要通过微信小程序使用平台，H5为辅助渠道
- 分销层级限制为2级（直推+间推），符合法规要求
- 押金在用户完成租借后自动退还到用户钱包，可申请提现
- 酒店房间内部署的智能柜与普通场地智能柜使用相同的设备协议和控制方式
- 酒店入住核销需要前台人工操作，系统提供核销码验证接口
